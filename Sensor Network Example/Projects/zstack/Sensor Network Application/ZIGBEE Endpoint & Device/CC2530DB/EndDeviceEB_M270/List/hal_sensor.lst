###############################################################################
#                                                                             #
# IAR C/C++ Compiler V7.51A/W32 for 8051                01/Dec/2010  16:52:52 #
# Copyright 2004-2009 IAR Systems AB.                                         #
#                                                                             #
#    Core               =  plain                                              #
#    Code model         =  banked                                             #
#    Data model         =  large                                              #
#    Calling convention =  xdata reentrant                                    #
#    Constant location  =  data_rom                                           #
#    Dptr setup         =  1,16                                               #
#    Source file        =  D:\R.D Dept\程式開發\TI CC2530 example\ZIGBEE      #
#                          Z-Stack\CC2530_ZStack-2.3.0-1.4.0\Sensor Network   #
#                          Example\Projects\zstack\Sensor Network             #
#                          Application\ZIGBEE Endpoint &                      #
#                          Device\Source\hal_sensor.c                         #
#    Command line       =  -f "D:\R.D Dept\程式開發\TI CC2530 example\ZIGBEE  #
#                          Z-Stack\CC2530_ZStack-2.3.0-1.4.0\Sensor Network   #
#                          Example\Projects\zstack\Sensor Network             #
#                          Application\ZIGBEE Endpoint &                      #
#                          Device\CC2530DB\..\..\..\Tools\CC2530DB\f8wEndev.c #
#                          fg" (-DCPU32MHZ -DROOT=__near_func -DBLINK_LEDS)   #
#                          -f "D:\R.D Dept\程式開發\TI CC2530 example\ZIGBEE  #
#                          Z-Stack\CC2530_ZStack-2.3.0-1.4.0\Sensor Network   #
#                          Example\Projects\zstack\Sensor Network             #
#                          Application\ZIGBEE Endpoint &                      #
#                          Device\CC2530DB\..\..\..\Tools\CC2530DB\f8wConfig. #
#                          cfg" (-DSECURE=0 -DZG_SECURE_DYNAMIC=0             #
#                          -DREFLECTOR -DDEFAULT_CHANLIST=0x00000800          #
#                          -DZDAPP_CONFIG_PAN_ID=0xFFFF                       #
#                          -DNWK_START_DELAY=100 -DEXTENDED_JOINING_RANDOM_MA #
#                          SK=0x007F -DBEACON_REQUEST_DELAY=100               #
#                          -DBEACON_REQ_DELAY_MASK=0x00FF                     #
#                          -DROUTE_EXPIRY_TIME=30 -DAPSC_ACK_WAIT_DURATION_PO #
#                          LLED=3000 -DNWK_INDIRECT_MSG_TIMEOUT=7             #
#                          -DMAX_RREQ_ENTRIES=8 -DAPSC_MAX_FRAME_RETRIES=3    #
#                          -DNWK_MAX_DATA_RETRIES=2                           #
#                          -DMAX_POLL_FAILURE_RETRIES=2 -DMAX_BCAST=9         #
#                          -DAPS_MAX_GROUPS=16 -DMAX_RTG_ENTRIES=40           #
#                          -DNWK_MAX_BINDING_ENTRIES=4                        #
#                          -DMAX_BINDING_CLUSTER_IDS=4 "-DDEFAULT_KEY={0x01,  #
#                          0x03, 0x05, 0x07, 0x09, 0x0B, 0x0D, 0x0F, 0x00,    #
#                          0x02, 0x04, 0x06, 0x08, 0x0A, 0x0C, 0x0D}"         #
#                          -DMAC_MAX_FRAME_SIZE=116 "-DCONST=const __code"    #
#                          -DGENERIC=__generic -DRFD_RCVC_ALWAYS_ON=TRUE      #
#                          -DPOLL_RATE=1000 -DQUEUED_POLL_RATE=100            #
#                          -DRESPONSE_POLL_RATE=100 -DREJOIN_POLL_RATE=440)   #
#                          -f "D:\R.D Dept\程式開發\TI CC2530 example\ZIGBEE  #
#                          Z-Stack\CC2530_ZStack-2.3.0-1.4.0\Sensor Network   #
#                          Example\Projects\zstack\Sensor Network             #
#                          Application\ZIGBEE Endpoint &                      #
#                          Device\CC2530DB\..\..\..\Tools\CC2530DB\f8wZCL.cfg #
#                          " (-DZCL_READ -DZCL_WRITE -DZCL_BASIC              #
#                          -DZCL_IDENTIFY -DZCL_ON_OFF -DZCL_KEY_ESTABLISH    #
#                          -DZCL_LOAD_CONTROL -DZCL_SIMPLE_METERING           #
#                          -DZCL_PRICING) -DZCL_MESSAGE "D:\R.D               #
#                          Dept\程式開發\TI CC2530 example\ZIGBEE             #
#                          Z-Stack\CC2530_ZStack-2.3.0-1.4.0\Sensor Network   #
#                          Example\Projects\zstack\Sensor Network             #
#                          Application\ZIGBEE Endpoint &                      #
#                          Device\Source\hal_sensor.c" -D NWK_AUTO_POLL -D    #
#                          ZTOOL_P1 -D MT_TASK -D MT_APP_FUNC -D MT_SYS_FUNC  #
#                          -D MT_ZDO_FUNC -D LCD_SUPPORTED=DEBUG -D           #
#                          xPOWER_SAVING -D End_Device -D HAL_KEYPAD -D M270  #
#                          -D xPA2591 -lC "D:\R.D Dept\程式開發\TI CC2530     #
#                          example\ZIGBEE Z-Stack\CC2530_ZStack-2.3.0-1.4.0\S #
#                          ensor Network Example\Projects\zstack\Sensor       #
#                          Network Application\ZIGBEE Endpoint &              #
#                          Device\CC2530DB\EndDeviceEB_M270\List\" -lA        #
#                          "D:\R.D Dept\程式開發\TI CC2530 example\ZIGBEE     #
#                          Z-Stack\CC2530_ZStack-2.3.0-1.4.0\Sensor Network   #
#                          Example\Projects\zstack\Sensor Network             #
#                          Application\ZIGBEE Endpoint &                      #
#                          Device\CC2530DB\EndDeviceEB_M270\List\"            #
#                          --diag_suppress Pe001,Pa010 -o "D:\R.D             #
#                          Dept\程式開發\TI CC2530 example\ZIGBEE             #
#                          Z-Stack\CC2530_ZStack-2.3.0-1.4.0\Sensor Network   #
#                          Example\Projects\zstack\Sensor Network             #
#                          Application\ZIGBEE Endpoint &                      #
#                          Device\CC2530DB\EndDeviceEB_M270\Obj\" -e          #
#                          --require_prototypes --debug --core=plain          #
#                          --dptr=16,1 --data_model=large                     #
#                          --code_model=banked --calling_convention=xdata_ree #
#                          ntrant --place_constants=data_rom                  #
#                          --nr_virtual_regs 16 -I "D:\R.D Dept\程式開發\TI   #
#                          CC2530 example\ZIGBEE Z-Stack\CC2530_ZStack-2.3.0- #
#                          1.4.0\Sensor Network Example\Projects\zstack\Senso #
#                          r Network Application\ZIGBEE Endpoint &            #
#                          Device\CC2530DB\" -I "D:\R.D Dept\程式開發\TI      #
#                          CC2530 example\ZIGBEE Z-Stack\CC2530_ZStack-2.3.0- #
#                          1.4.0\Sensor Network Example\Projects\zstack\Senso #
#                          r Network Application\ZIGBEE Endpoint &            #
#                          Device\CC2530DB\..\SOURCE\" -I "D:\R.D             #
#                          Dept\程式開發\TI CC2530 example\ZIGBEE             #
#                          Z-Stack\CC2530_ZStack-2.3.0-1.4.0\Sensor Network   #
#                          Example\Projects\zstack\Sensor Network             #
#                          Application\ZIGBEE Endpoint &                      #
#                          Device\CC2530DB\..\..\SOURCE\" -I "D:\R.D          #
#                          Dept\程式開發\TI CC2530 example\ZIGBEE             #
#                          Z-Stack\CC2530_ZStack-2.3.0-1.4.0\Sensor Network   #
#                          Example\Projects\zstack\Sensor Network             #
#                          Application\ZIGBEE Endpoint &                      #
#                          Device\CC2530DB\..\..\..\ZMAIN\TI2530DB\" -I       #
#                          "D:\R.D Dept\程式開發\TI CC2530 example\ZIGBEE     #
#                          Z-Stack\CC2530_ZStack-2.3.0-1.4.0\Sensor Network   #
#                          Example\Projects\zstack\Sensor Network             #
#                          Application\ZIGBEE Endpoint &                      #
#                          Device\CC2530DB\..\..\..\..\..\COMPONENTS\MT\" -I  #
#                          "D:\R.D Dept\程式開發\TI CC2530 example\ZIGBEE     #
#                          Z-Stack\CC2530_ZStack-2.3.0-1.4.0\Sensor Network   #
#                          Example\Projects\zstack\Sensor Network             #
#                          Application\ZIGBEE Endpoint &                      #
#                          Device\CC2530DB\..\..\..\..\..\COMPONENTS\HAL\INCL #
#                          UDE\" -I "D:\R.D Dept\程式開發\TI CC2530           #
#                          example\ZIGBEE Z-Stack\CC2530_ZStack-2.3.0-1.4.0\S #
#                          ensor Network Example\Projects\zstack\Sensor       #
#                          Network Application\ZIGBEE Endpoint &              #
#                          Device\CC2530DB\..\..\..\..\..\COMPONENTS\HAL\MODU #
#                          LE\" -I "D:\R.D Dept\程式開發\TI CC2530            #
#                          example\ZIGBEE Z-Stack\CC2530_ZStack-2.3.0-1.4.0\S #
#                          ensor Network Example\Projects\zstack\Sensor       #
#                          Network Application\ZIGBEE Endpoint &              #
#                          Device\CC2530DB\..\..\..\..\..\COMPONENTS\HAL\TARG #
#                          ET\CC2530EB\" -I "D:\R.D Dept\程式開發\TI CC2530   #
#                          example\ZIGBEE Z-Stack\CC2530_ZStack-2.3.0-1.4.0\S #
#                          ensor Network Example\Projects\zstack\Sensor       #
#                          Network Application\ZIGBEE Endpoint &              #
#                          Device\CC2530DB\..\..\..\..\..\COMPONENTS\OSAL\MCU #
#                          \CCSOC\" -I "D:\R.D Dept\程式開發\TI CC2530        #
#                          example\ZIGBEE Z-Stack\CC2530_ZStack-2.3.0-1.4.0\S #
#                          ensor Network Example\Projects\zstack\Sensor       #
#                          Network Application\ZIGBEE Endpoint &              #
#                          Device\CC2530DB\..\..\..\..\..\COMPONENTS\OSAL\INC #
#                          LUDE\" -I "D:\R.D Dept\程式開發\TI CC2530          #
#                          example\ZIGBEE Z-Stack\CC2530_ZStack-2.3.0-1.4.0\S #
#                          ensor Network Example\Projects\zstack\Sensor       #
#                          Network Application\ZIGBEE Endpoint &              #
#                          Device\CC2530DB\..\..\..\..\..\COMPONENTS\STACK\AF #
#                          \" -I "D:\R.D Dept\程式開發\TI CC2530              #
#                          example\ZIGBEE Z-Stack\CC2530_ZStack-2.3.0-1.4.0\S #
#                          ensor Network Example\Projects\zstack\Sensor       #
#                          Network Application\ZIGBEE Endpoint &              #
#                          Device\CC2530DB\..\..\..\..\..\COMPONENTS\STACK\NW #
#                          K\" -I "D:\R.D Dept\程式開發\TI CC2530             #
#                          example\ZIGBEE Z-Stack\CC2530_ZStack-2.3.0-1.4.0\S #
#                          ensor Network Example\Projects\zstack\Sensor       #
#                          Network Application\ZIGBEE Endpoint &              #
#                          Device\CC2530DB\..\..\..\..\..\COMPONENTS\STACK\SE #
#                          C\" -I "D:\R.D Dept\程式開發\TI CC2530             #
#                          example\ZIGBEE Z-Stack\CC2530_ZStack-2.3.0-1.4.0\S #
#                          ensor Network Example\Projects\zstack\Sensor       #
#                          Network Application\ZIGBEE Endpoint &              #
#                          Device\CC2530DB\..\..\..\..\..\COMPONENTS\STACK\SA #
#                          PI\" -I "D:\R.D Dept\程式開發\TI CC2530            #
#                          example\ZIGBEE Z-Stack\CC2530_ZStack-2.3.0-1.4.0\S #
#                          ensor Network Example\Projects\zstack\Sensor       #
#                          Network Application\ZIGBEE Endpoint &              #
#                          Device\CC2530DB\..\..\..\..\..\COMPONENTS\STACK\SY #
#                          S\" -I "D:\R.D Dept\程式開發\TI CC2530             #
#                          example\ZIGBEE Z-Stack\CC2530_ZStack-2.3.0-1.4.0\S #
#                          ensor Network Example\Projects\zstack\Sensor       #
#                          Network Application\ZIGBEE Endpoint &              #
#                          Device\CC2530DB\..\..\..\..\..\COMPONENTS\STACK\ZC #
#                          L\" -I "D:\R.D Dept\程式開發\TI CC2530             #
#                          example\ZIGBEE Z-Stack\CC2530_ZStack-2.3.0-1.4.0\S #
#                          ensor Network Example\Projects\zstack\Sensor       #
#                          Network Application\ZIGBEE Endpoint &              #
#                          Device\CC2530DB\..\..\..\..\..\COMPONENTS\STACK\ZD #
#                          O\" -I "D:\R.D Dept\程式開發\TI CC2530             #
#                          example\ZIGBEE Z-Stack\CC2530_ZStack-2.3.0-1.4.0\S #
#                          ensor Network Example\Projects\zstack\Sensor       #
#                          Network Application\ZIGBEE Endpoint &              #
#                          Device\CC2530DB\..\..\..\..\..\COMPONENTS\ZMAC\F8W #
#                          \" -I "D:\R.D Dept\程式開發\TI CC2530              #
#                          example\ZIGBEE Z-Stack\CC2530_ZStack-2.3.0-1.4.0\S #
#                          ensor Network Example\Projects\zstack\Sensor       #
#                          Network Application\ZIGBEE Endpoint &              #
#                          Device\CC2530DB\..\..\..\..\..\COMPONENTS\ZMAC\"   #
#                          -I "D:\R.D Dept\程式開發\TI CC2530 example\ZIGBEE  #
#                          Z-Stack\CC2530_ZStack-2.3.0-1.4.0\Sensor Network   #
#                          Example\Projects\zstack\Sensor Network             #
#                          Application\ZIGBEE Endpoint &                      #
#                          Device\CC2530DB\..\..\..\..\..\COMPONENTS\SERVICES #
#                          \SADDR\" -I "D:\R.D Dept\程式開發\TI CC2530        #
#                          example\ZIGBEE Z-Stack\CC2530_ZStack-2.3.0-1.4.0\S #
#                          ensor Network Example\Projects\zstack\Sensor       #
#                          Network Application\ZIGBEE Endpoint &              #
#                          Device\CC2530DB\..\..\..\..\..\COMPONENTS\SERVICES #
#                          \SDATA\" -I "D:\R.D Dept\程式開發\TI CC2530        #
#                          example\ZIGBEE Z-Stack\CC2530_ZStack-2.3.0-1.4.0\S #
#                          ensor Network Example\Projects\zstack\Sensor       #
#                          Network Application\ZIGBEE Endpoint &              #
#                          Device\CC2530DB\..\..\..\..\..\COMPONENTS\MAC\INCL #
#                          UDE\" -I "D:\R.D Dept\程式開發\TI CC2530           #
#                          example\ZIGBEE Z-Stack\CC2530_ZStack-2.3.0-1.4.0\S #
#                          ensor Network Example\Projects\zstack\Sensor       #
#                          Network Application\ZIGBEE Endpoint &              #
#                          Device\CC2530DB\..\..\..\..\..\COMPONENTS\MAC\HIGH #
#                          _LEVEL\" -I "D:\R.D Dept\程式開發\TI CC2530        #
#                          example\ZIGBEE Z-Stack\CC2530_ZStack-2.3.0-1.4.0\S #
#                          ensor Network Example\Projects\zstack\Sensor       #
#                          Network Application\ZIGBEE Endpoint &              #
#                          Device\CC2530DB\..\..\..\..\..\COMPONENTS\MAC\LOW_ #
#                          LEVEL\srf04\" -I "D:\R.D Dept\程式開發\TI CC2530   #
#                          example\ZIGBEE Z-Stack\CC2530_ZStack-2.3.0-1.4.0\S #
#                          ensor Network Example\Projects\zstack\Sensor       #
#                          Network Application\ZIGBEE Endpoint &              #
#                          Device\CC2530DB\..\..\..\..\..\COMPONENTS\MAC\LOW_ #
#                          LEVEL\srf04\SINGLE_CHIP\" -I "C:\IAR               #
#                          Systems\Embedded Workbench for MCS-51              #
#                          V7.51\8051\INC\" -I "C:\IAR Systems\Embedded       #
#                          Workbench for MCS-51 V7.51\8051\INC\CLIB\" -Ohz    #
#    List file          =  D:\R.D Dept\程式開發\TI CC2530 example\ZIGBEE      #
#                          Z-Stack\CC2530_ZStack-2.3.0-1.4.0\Sensor Network   #
#                          Example\Projects\zstack\Sensor Network             #
#                          Application\ZIGBEE Endpoint &                      #
#                          Device\CC2530DB\EndDeviceEB_M270\List\hal_sensor.l #
#                          st                                                 #
#    Object file        =  D:\R.D Dept\程式開發\TI CC2530 example\ZIGBEE      #
#                          Z-Stack\CC2530_ZStack-2.3.0-1.4.0\Sensor Network   #
#                          Example\Projects\zstack\Sensor Network             #
#                          Application\ZIGBEE Endpoint &                      #
#                          Device\CC2530DB\EndDeviceEB_M270\Obj\hal_sensor.r5 #
#                          1                                                  #
#                                                                             #
#                                                                             #
###############################################################################

D:\R.D Dept\程式開發\TI CC2530 example\ZIGBEE Z-Stack\CC2530_ZStack-2.3.0-1.4.0\Sensor Network Example\Projects\zstack\Sensor Network Application\ZIGBEE Endpoint & Device\Source\hal_sensor.c
      1          /**************************************************************************************************
      2            Filename:       hal_sensor.c
      3            Revised:        $Date: 2010-07-14 (Wed, 14 July 2010) $
      4            Revision:       $Revision: 19453 $
      5          
      6            Description:    HAL Sensor - the device receive the sensor data application.
      7          **************************************************************************************************/
      8          /*********************************************************************
      9           * INCLUDES
     10           */  
     11          #include "ZComDef.h"
     12          #include "OSAL.h"
     13          #include "AF.h"
     14          #include "ZDApp.h"
     15          #include "ZDObject.h"
     16          #include "ZDProfile.h"
     17          
     18          #include "mac_radio_defs.h"
     19          
     20          /* ZCL */
     21          #include "zcl.h"
     22          #include "zcl_general.h"
     23          #include "zcl_ha.h"
     24          #include "zcl_zigbee device.h"
     25          
     26          /* HAL */
     27          #include "onboard.h"
     28          #include "hal_lcd.h"
     29          #include "hal_led.h"
     30          #include "hal_key.h"
     31          #include "MT_UART.h"
     32          #include "hal_uart.h"
     33          #include "hal_timer.h"
     34          #include "hal_keypad.h"
     35          #include "hal_buzzer.h"
     36            
     37          /* HAL Sensor */
     38          #include "hal_sensor.h"
     39          
     40          #if defined(M140)
     41            #include "M140.h"
     42          #endif
     43          #if defined(M160)
     44            #include "M160.h"
     45          #endif
     46          #if defined(M170)
     47            #include "M170.h"
     48          #endif
     49          #if defined(M200)
     50            #include "M200.h"
     51          #endif
     52          #if defined(M270)
     53            #include "M270.h"
     54          #endif
     55          
     56          /*********************************************************************
     57           * GLOBAL VARIABLES
     58           */

   \                                 In  segment XDATA_Z, align 1, keep-with-next
     59           byte TransmitApp_Msg[ TRANSMITAPP_MAX_DATA_LEN ]; 
   \                     TransmitApp_Msg:
   \   000000                DS 102
   \   000066                REQUIRE __INIT_XDATA_Z
     60           
     61          /*********************************************************************
     62           * LOCAL VARIABLES
     63           */
     64          /*********************************************************************
     65           * LOCAL FUNCTIONS
     66           */
     67           void M140_SensorFunction(void); // M140 Module function
     68           void M160_SensorFunction(void); // M160 Module function
     69           void M170_SensorFunction(void); // M170 Module function
     70           void M200_SensorFunction(void); // M200 Module function
     71           void M270_SensorFunction(void); // M270 Module function
     72          
     73          #if defined(M140)
     74          /*********************************************************************
     75           * @fn          M140_SensorFunction
     76           * @brief       The ZIGBEE Device to receive the M140 tempture data.
     77           */
     78           void M140_SensorFunction(void)
     79           {
     80            // M140 sensor variable
     81            uint16 val;
     82            uint8 tmp1, tmp2, tmp3, tmp4;
     83            
     84            // ZCL transmit variable
     85            uint8 len;
     86            
     87            // initilization the device
     88            M140_Init();
     89                
     90            val = M140_GetValue();  
     91            if((0x2000 & val) == 0x2000) // check sign bit for negative value
     92            {
     93              val = ((val - 16384) * 10) / 32;
     94            }
     95            else
     96            {
     97              val = (val * 10) / 32;
     98            }
     99            tmp1 = (val / 100) + '0';
    100            TransmitApp_Msg[0] = tmp1;
    101            tmp2 = ((val / 10) % 10) + '0';
    102            TransmitApp_Msg[1] = tmp2;
    103            tmp3 = '.';
    104            TransmitApp_Msg[2] = tmp3;
    105            tmp4 = (val % 10) + '0';
    106            TransmitApp_Msg[3] = tmp4;
    107            
    108            len = 4;
    109              
    110          #if defined ( LCD_SUPPORTED )
    111            HalLcdWriteString("* Z-Stack M140 *", HAL_LCD_LINE_1);
    112            HalLcdWriteString(" Temp. =       C", HAL_LCD_LINE_2);
    113            HalLcdWriteChar(HAL_LCD_LINE_2, 14, 0xDF);
    114            HalLcdWriteChar(HAL_LCD_LINE_2, 9, tmp1);
    115            HalLcdWriteChar(HAL_LCD_LINE_2, 10, tmp2);
    116            HalLcdWriteChar(HAL_LCD_LINE_2, 11, tmp3);
    117            HalLcdWriteChar(HAL_LCD_LINE_2, 12, tmp4);
    118          #endif 
    119          
    120            len = 4;
    121            uint8 temp = zcl_SendCommand( ZIGBEEDEVICE_ENDPOINT, &zclZigbeeDevice_DstAddr, ZCL_CLUSTER_ID_GEN_ON_OFF, 
    122                                          ZCL_CLUSTER_ID_GEN_BASIC, TRUE, ZCL_FRAME_CLIENT_SERVER_DIR, false, 0, 0, len, TransmitApp_Msg );   
    123           }
    124          #endif
    125          
    126          #if defined(M160)
    127          /*********************************************************************
    128           * @fn          M160_SensorFunction
    129           * @brief       The ZIGBEE Device to receive the M160 tempture data.
    130           */
    131           void M160_SensorFunction(void)
    132           {
    133            // M160 sensor variable
    134            static uint8 duty = 50;
    135            
    136            // initilization the device
    137            M160_Init();
    138            
    139            if (ch > 0)
    140            {           
    141              if (ch == 'U')
    142              {
    143                if (duty < 100)
    144                {
    145                  duty = duty + 5;
    146                }
    147              }
    148              
    149              if (ch == 'N')
    150              {
    151                if (duty > 0)
    152                {
    153                  duty = duty - 5;
    154                }
    155              }
    156                
    157              M160_On(duty);
    158              #if defined ( LCD_SUPPORTED )
    159                HalLcdWriteString("** M160 Test  **", HAL_LCD_LINE_1);
    160                HalLcdWriteString("   Duty =     % ", HAL_LCD_LINE_2);
    161                halLcdDisplayUint8(HAL_LCD_LINE_2, 10, HAL_LCD_RADIX_DEC, duty); 
    162              #endif
    163            }
    164          //  M160_Off();
    165           }
    166          #endif 
    167          
    168           
    169          #if defined(M170)
    170          /*********************************************************************
    171           * @fn          M170_SensorFunction
    172           * @brief       The ZIGBEE Device to receive the M170 optical data.
    173           */
    174           void M170_SensorFunction(void)
    175           {
    176              // M170 sensor variable
    177              uint16 val;
    178              uint8 tmp1, tmp2, tmp3;
    179              // ZCL transmit variable
    180              uint8 len;
    181                
    182              // initilization the device
    183              M170_Init();
    184            
    185             val = M170_GetValue();
    186             if (val > 2000)
    187             {
    188                val -= 2000;
    189             }
    190             else
    191              {
    192                val = 0;
    193              }val /= 120;
    194                      
    195             if (val > 100)
    196             {
    197                val = 100;
    198             }
    199             
    200             tmp1 = (val / 100) + '0';
    201             TransmitApp_Msg[0] = tmp1;
    202             tmp2 = ((val / 10) % 10) + '0';
    203             TransmitApp_Msg[1] = tmp2;
    204             tmp3 = (val % 10) + '0';
    205             TransmitApp_Msg[2] = tmp3;
    206             
    207          #if defined ( LCD_SUPPORTED )
    208             HalLcdWriteString("* Z-Stack M170 *", HAL_LCD_LINE_1);
    209             HalLcdWriteString(" Bright =     % ", HAL_LCD_LINE_2);
    210             HalLcdWriteChar(HAL_LCD_LINE_2, 10, tmp1);
    211             HalLcdWriteChar(HAL_LCD_LINE_2, 11, tmp2);
    212             HalLcdWriteChar(HAL_LCD_LINE_2, 12, tmp3);
    213          #endif
    214             
    215             len = 3;
    216             uint8 temp = zcl_SendCommand( ZIGBEEDEVICE_ENDPOINT, &zclZigbeeDevice_DstAddr, ZCL_CLUSTER_ID_GEN_ON_OFF, ZCL_CLUSTER_ID_GEN_BASIC,
    217                                           TRUE, ZCL_FRAME_CLIENT_SERVER_DIR, false, 0, 0, len, TransmitApp_Msg );
    218           }
    219          #endif
    220           
    221          #if defined(M200)
    222          /*********************************************************************
    223           * @fn          M200_SensorFunction
    224           * @brief       The ZIGBEE Device to receive the M200 Temp and Humi data.
    225           */
    226           void M200_SensorFunction(void)
    227           {
    228              // M200 module variable
    229              uint16 temp, humi;
    230              uint8 hum_1,hum_2,hum_3,hum_4;
    231              uint8 temp_1,temp_2,temp_3,temp_4;
    232              uint8 len;
    233                
    234              // initilization the device
    235              M200_Init();
    236            
    237              M200_GetValue();
    238              temp = (uint16)(((((float)M200_Temp) *0.01) - 40.0) *10.0);
    239              humi = (uint16)(((((float)M200_Humi) *0.0405) - (((float)M200_Humi)*((float)M200_Humi) *0.0000028) - 4.0) *10.0);
    240              if (humi > 999)
    241              {
    242                humi = 999;
    243              }
    244              if (temp > 999)
    245              {
    246                temp = 999;
    247              }
    248              hum_1 = (humi / 100) + '0';
    249              TransmitApp_Msg[0] = hum_1;
    250              hum_2 = ((humi / 10) % 10) + '0';
    251              TransmitApp_Msg[1] = hum_2;
    252              hum_3 = '.';
    253              TransmitApp_Msg[2] = hum_3;
    254              hum_4 = (humi % 10) + '0';
    255              TransmitApp_Msg[3] = hum_4;
    256              TransmitApp_Msg[4] = ' ';
    257              temp_1 = (temp / 100) + '0';
    258              TransmitApp_Msg[5] = temp_1;
    259              temp_2 = ((temp / 10) % 10) + '0';
    260              TransmitApp_Msg[6] = temp_2;
    261              temp_3 = '.';
    262              TransmitApp_Msg[7] = temp_3;
    263              temp_4 = (temp % 10) + '0';
    264              TransmitApp_Msg[8] = temp_4;
    265              
    266              #if defined ( LCD_SUPPORTED )
    267                HalLcdWriteString("Humidity=      %", HAL_LCD_LINE_1);
    268                HalLcdWriteString(" Temp. =       C", HAL_LCD_LINE_2);
    269                // Humi
    270                HalLcdWriteChar(HAL_LCD_LINE_1, 10, hum_1);
    271                HalLcdWriteChar(HAL_LCD_LINE_1, 11, hum_2);
    272                HalLcdWriteChar(HAL_LCD_LINE_1, 12, hum_3);
    273                HalLcdWriteChar(HAL_LCD_LINE_1, 13, hum_4);
    274                // Temp
    275                HalLcdWriteChar(HAL_LCD_LINE_2, 9, temp_1);
    276                HalLcdWriteChar(HAL_LCD_LINE_2, 10, temp_2);
    277                HalLcdWriteChar(HAL_LCD_LINE_2, 11, temp_3);
    278                HalLcdWriteChar(HAL_LCD_LINE_2, 12, temp_4);
    279              #endif
    280          
    281              len = 9;
    282              uint8 tmp = zcl_SendCommand( ZIGBEEDEVICE_ENDPOINT, &zclZigbeeDevice_DstAddr, ZCL_CLUSTER_ID_GEN_ON_OFF, 
    283                                           ZCL_CLUSTER_ID_GEN_BASIC, TRUE, ZCL_FRAME_CLIENT_SERVER_DIR, false, 0, 0, len, TransmitApp_Msg );
    284           }
    285          #endif
    286           
    287          #if defined(M270)
    288          /*********************************************************************
    289           * @fn          M270_SensorFunction
    290           * @brief       The ZIGBEE Device to receive the M200 Temp and Humi data.
    291           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    292           void M270_SensorFunction(void)
   \                     M270_SensorFunction:
    293           {
   \   000000   C082         PUSH    DPL
   \   000002   C083         PUSH    DPH
   \   000004                ; Saved register size: 2
   \   000004                ; Auto size: 0
    294              static uint8 udo;
    295          
    296              M270_Init();
   \   000004                ; Setup parameters for call to function M270_Init
   \   000004   12....       LCALL   ??M270_Init?relay
    297              
    298               if( ch == 'A' )
   \   000007   90....       MOV     DPTR,#ch
   \   00000A   E0           MOVX    A,@DPTR
   \   00000B   6441         XRL     A,#0x41
   \   00000D   700A         JNZ     ??M270_SensorFunction_0
    299               {
    300                  udo = 1;
   \   00000F   7401         MOV     A,#0x1
   \   000011   90....       MOV     DPTR,#??udo
   \   000014   F0           MOVX    @DPTR,A
    301                  M270_SetDO(udo);
   \   000015                ; Setup parameters for call to function M270_SetDO
   \   000015   F9           MOV     R1,A
   \   000016   12....       LCALL   ??M270_SetDO?relay
    302               }
    303               
    304               if( ch == 'D' )
   \                     ??M270_SensorFunction_0:
   \   000019   90....       MOV     DPTR,#ch
   \   00001C   E0           MOVX    A,@DPTR
   \   00001D   6444         XRL     A,#0x44
   \   00001F   7009         JNZ     ??M270_SensorFunction_1
    305               {
    306                  udo = 0;
   \   000021   E4           CLR     A
   \   000022   90....       MOV     DPTR,#??udo
   \   000025   F0           MOVX    @DPTR,A
    307                  M270_SetDO(udo);
   \   000026                ; Setup parameters for call to function M270_SetDO
   \   000026   F9           MOV     R1,A
   \   000027   12....       LCALL   ??M270_SetDO?relay
    308               }
    309              
    310               #if defined ( LCD_SUPPORTED )
    311                  HalLcdWriteString("** M270 Test  **", HAL_LCD_LINE_1);
   \                     ??M270_SensorFunction_1:
   \   00002A                ; Setup parameters for call to function HalLcdWriteString
   \   00002A   7901         MOV     R1,#0x1
   \   00002C   7A..         MOV     R2,#(`?<Constant "** M270 Test  **">` & 0xff)
   \   00002E   7B..         MOV     R3,#((`?<Constant "** M270 Test  **">` >> 8) & 0xff)
   \   000030   12....       LCALL   ??HalLcdWriteString?relay
    312                  HalLcdWriteString("* RELAY DO=[0] *", HAL_LCD_LINE_2);
   \   000033                ; Setup parameters for call to function HalLcdWriteString
   \   000033   7902         MOV     R1,#0x2
   \   000035   7A..         MOV     R2,#(`?<Constant "* RELAY DO=[0] *">` & 0xff)
   \   000037   7B..         MOV     R3,#((`?<Constant "* RELAY DO=[0] *">` >> 8) & 0xff)
   \   000039   12....       LCALL   ??HalLcdWriteString?relay
    313                  // Show the control value
    314                  HalLcdWriteChar(HAL_LCD_LINE_2, 12, udo + '0');
   \   00003C                ; Setup parameters for call to function HalLcdWriteChar
   \   00003C   90....       MOV     DPTR,#??udo
   \   00003F   E0           MOVX    A,@DPTR
   \   000040   2430         ADD     A,#0x30
   \   000042   FB           MOV     R3,A
   \   000043   7A0C         MOV     R2,#0xc
   \   000045   7902         MOV     R1,#0x2
   \   000047   12....       LCALL   ??HalLcdWriteChar?relay
    315               #endif
    316           }
   \   00004A   D083         POP     DPH
   \   00004C   D082         POP     DPL
   \   00004E   02....       LJMP    ?BRET

   \                                 In  segment XDATA_Z, align 1, keep-with-next
   \                     ??udo:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??M270_SensorFunction?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    M270_SensorFunction

   \                                 In  segment XDATA_ROM_C, align 1
   \                     `?<Constant "** M270 Test  **">`:
   \   000000   2A2A204D     DB "** M270 Test  **"
   \            32373020
   \            54657374
   \            20202A2A
   \            00      

   \                                 In  segment XDATA_ROM_C, align 1
   \                     `?<Constant "* RELAY DO=[0] *">`:
   \   000000   2A205245     DB "* RELAY DO=[0] *"
   \            4C415920
   \            444F3D5B
   \            305D202A
   \            00      
    317          #endif

   Maximum stack usage in bytes:

     Function               ISTACK PSTACK XSTACK
     --------               ------ ------ ------
     M270_SensorFunction        2      0      0
       -> M270_Init             4      0      0
       -> M270_SetDO            4      0      0
       -> M270_SetDO            4      0      0
       -> HalLcdWriteString     4      0      0
       -> HalLcdWriteString     4      0      0
       -> HalLcdWriteChar       4      0      0


   Segment part sizes:

     Function/Label                 Bytes
     --------------                 -----
     TransmitApp_Msg                 102
     M270_SensorFunction              81
     udo                               1
     ??M270_SensorFunction?relay       6
     ?<Constant "** M270 Test  **">   17
     ?<Constant "* RELAY DO=[0] *">   17

 
  81 bytes in segment BANKED_CODE
   6 bytes in segment BANK_RELAYS
  34 bytes in segment XDATA_ROM_C
 103 bytes in segment XDATA_Z
 
  87 bytes of CODE  memory
  34 bytes of CONST memory
 103 bytes of XDATA memory

Errors: none
Warnings: none
